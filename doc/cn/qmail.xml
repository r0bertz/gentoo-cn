<?xml version='1.0' encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" href="/xsl/guide.xsl" ?>
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="qmail.xml">
<title>用qmail/vpopmail/courier-imap/qmail-scanner/igenus打造邮件系统</title>
<author title="Author">
  <mail link="max@microweb.3322.org">maxzhongcn</mail>
</author>
<author title="Editor">
  <mail link="qmm01@mails.tsinghua.edu.cn">links</mail>
</author>

<abstract>
本指南将告诉你如何用qmail/vpopmail/courier-imap/qmail-scanner/igenus来打造一个邮件系统。
</abstract>

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/1.0 -->
<license/>

<version>1.0</version>
<date>29 Jul 2004</date>

<chapter>
<title>前言</title>

<body>
<p>
本文部分内容翻译自<uri link="http://forums.gentoo.org/viewtopic.php?t=171499">Gentoo Forums</uri>。您可以访问上面的地址查看最新版本。
</p>
</body>
</chapter>

<chapter>
<title>设置USE环境变量</title>
<body>
<p>
首先设置好 USE 环境变量，修改 /etc/make.conf，添加如下 USE 变量：
</p>
<pre caption="/etc/make.conf">
USE=apache2 maildir mysql
</pre>
</body>
</chapter>

<chapter>
<title>安装 qmail</title>
<body>
<p>
首先你要确保已经卸载了其他相关邮件处理软件，如：ssmtp, sendmail 或 postfix，然后执行：
</p>

<pre caption="安装qmail">
# <i>emerge -C ssmtp sendmail postfix </i>
# <i>emerge /usr/portage/mail-mta/qmail/qmail-1.03-r13.ebuild </i>
# <i>ebuild var/db/pkg/mail-mta/qmail-1.03-r13/qmail-1.03-r13.ebuild config </i>
# <i>ln -s /var/qmail/supervise/qmail-send /service/qmail-send </i>
# <i>ln -s /var/qmail/supervise/qmail-smtpd /service/qmail-smtpd </i>
# <i>rc-update add svscan default </i>
# <i>/etc/init.d/svscan start </i>
</pre>
</body>
</chapter>

<chapter>
<title>安装vpopmail</title>
<body>
<pre caption="安装vpopmail">
# <i> emerge /usr/portage/net-mail/vpopmail/vpopmail-5.4.0.ebuild </i>
</pre>

<p>
以root身份登录你的mysql服务器作一下操作：
</p>
<pre caption="操作mysql服务器">
> <i>create database vpopmail;</i>
> <i>use mysql;</i>
> <i>grant select, insert, update, delete, create, drop on vpopmail.* to vpopmail@localhost identified by 'your password';</i>
> <i>flush privileges; </i>
</pre>

<p>
如果你发现 vpopmail 无法收取邮件，那么请确保 /etc/vpopmail.conf 文件的权限是 600 并由 vpopmail:vpopmail 所有。
</p>

<p>
下面修改 /etc/vpopmail.conf，修改其中的数据库密码为上面设置的密码。并且执行：
</p>
<pre>
# <i> chmod 644 /etc/vpopmail.conf </i>
# <i> chown vpopmail:vpopmail /etc/vpopmail.conf</i>
</pre>

</body>
</chapter>

<chapter>
<title>安装 courier-imap</title>
<body>
<pre caption="安装courier-imap">
# <i>emerge /usr/portage/net-mail/courier-imap/courier-imap-3.0.2-r1.ebuild </i>
# <i>nano -w /etc/courier-imap/authdaemonrc</i>
加入 authmodulelist="authvchkpw"
#<i>nano -w /etc/courier-imap/imapd </i>
加入 IMAPDSTART=YES
 AUTHMODULES="authvchkpw"
# <i>nano -w /etc/courier-imap/pop3d </i>
加入 POP3DSTART=YES
 AUTHMODULES="authvchkpw"
# <i>rc-update add courier-imapd default</i>
#<i>rc-update add courier-pop3d default</i>
#<i>/etc/init.d/courier-imapd start</i>
#<i>/etc/init.d/courier-pop3d start</i>
</pre>
</body>
</chapter>

<chapter>
<title>配置 smtpd 以使 smtp-auth 能够使用 vpopmail</title>
<body>
<pre>
# <i>nano -w /var/qmail/control/conf-smtpd </i>
加入 QMAIL_SMTP_POST="microweb.3322.org /var/vpopmail/bin/vchkpw /bin/true"
# <i>svc -t /var/qmail/supervise/qmail-smtpd </i>
# <i>chmod u+s /var/vpopmail/bin/vchkpw </i>
</pre>

<p>下面的操作可以大大加快邮件的传输速度，如果你发现邮件传输时有30到45秒的延迟，那么我强烈建议你做一下操作：
</p>

<pre>
# <i>nano -w /var/qmail/control/conf-common</i>
加入 TCPSERVER_OPTS="-H -R -l 0"
</pre>

</body>
</chapter>

<chapter>
<title>安装 spam 数据库客户端</title>
<body>
<pre>
# <i>emerge /usr/portage/dev-python/pyzor/pyzor-0.4.0-r1.ebuild</i>
# <i>emerge /usr/portage/mail-filter/razor/razor-2.40.ebuild</i>
# <i>emerge /usr/portage/mail-filter/dcc/dcc-1.2.28.ebuild</i>
</pre>
</body>
</chapter>

<chapter>
<title>安装 f-prot 和 Mail-SpamAssassin</title>
<body>
<p>
这两个软件必须在安装 qmail-scanner 前正常运行。
</p>
<pre>
# <i>emerge /usr/portage/app-antivirus/f-prot/f-prot-4.4.2.ebuild</i>
# <i>emerge /usr/portage/mail-filter/spamassassin/spamassassin-2.63.ebuild</i>
# <i>nano -w /etc/conf.d/spamd </i>
加入 SPAMD_OPTS="-d -u vpopmail -v -x -C /etc/mail/spamassassin/local.cf"
# <i>rc-update add spamd default</i>
# <i>/etc/init.d/spamd start</i>
</pre>
<p>
现在你可以建立一个 cron.hourly 任务以便自动更新 f-prot 定义：
</p>
<pre>
# <i>nano -w /etc/cron.hourly/virus-update.cron</i>
内容如下：
#!/bin/bash
/opt/f-prot/check-updates.pl -cron -quiet
</pre>
<pre>
# <i>chmod 755 /etc/cron.hourly/virus-update.cron</i>
# <i>crontab -e</i>
 min hour day month weekday command
0 * * * * /etc/cron.hourly/virus-update.cron
</pre>

<p>
现在来设置spam进程规则，在/etc/mail/spamassassin/local.cf里加入以下内容：
</p>
<pre caption="/etc/mail/spamassassin/local.cf">
required_hits 5.0
rewrite_subject 1
subject_tag *****SPAM*****
report_safe 1
report_header 1
use_bayes 1
auto_learn 1
skip_rbl_checks 0
use_razor2 1
use_dcc 1
use_pyzor 1
ok_languages all
ok_locales all
</pre>

</body>
</chapter>

<chapter>
<title>安装 qmail-scanner </title>
<body>
<p>
安装 qmail-scanner 之前你可能需要强制安装 maildrop。
</p>
<pre caption="安装maildrop">
# <i>emerge /usr/portage/mail-filter/maildrop/maildrop-1.5.3-r1.ebuild</i>
# <i>emerge /usr/portage/net-mail/qmail-scanner/qmail-scanner-1.16-r2.ebuild</i>
</pre>
<p>
以"qmaild"用户登录并运行：
</p>
<pre>
# <i>/var/qmail/bin/qmail-scanner-queue.pl -g</i>
</pre>
<p>
如果你看到 "Can't do setuid" 或 "Permission denied" 错误提示请查阅 FAQ。
(如："setuidgid qmaild "/var/qmail/bin/qmail-scanner-queue.pl -g"
或 "su qmaild -c "/var/qmail/bin/qmail-scanner-queue.pl -g")
</p>
<p>
/etc/mail/sendmail/local.cf 中的 'subject_tag' 变量好像不能正确修改 spam 检测到的subject，所以我们这样修改：
</p>
<pre>
# <i>nano -w /var/qmail/bin/qmail-scanner-queue.pl</i>
加入 my $spamc_subject='*****SPAM*****';
</pre>

<p>现在来配置 tcp.smtp 以激活 qmail-scanner：</p>

<pre>
# <i>nano -w /etc/tcp.smtp</i>
加入
# Qmail-Scanner disabled for mail from localhost, relay allowed
127.0.0.1:allow,RELAYCLIENT="",RBLSMTPD="",QMAILQUEUE="/var/qmail/bin/qmail-queue"
# Qmail-Scanner enabled (virus only) for mail from local network, relay allowed
192.168.1.:allow,RELAYCLIENT="",RBLSMTPD="",QMAILQUEUE="/var/qmail/bin/qmail-scanner-queue.pl"
# Qmail-Scanner enabled (virus and spam) for mail from external internet, relay denied
:allow,QMAILQUEUE="/var/qmail/bin/qmail-scanner-queue.pl"
</pre>

<pre>
# <i>tcprules /etc/tcp.smtp.cdb /etc/tcp.smtp.tmp &lt; /etc/tcp.smtp</i>
# <i>chmod 644 /etc/tcp.smtp*</i>
</pre>

</body>
</chapter>

<chapter>
<title>安装 qmailadmin </title>
<body>
<pre>
# <i>emerge /usr/portage/net-mail/ezmlm-idx-mysql/ezmlm-idx-mysql-0.40-r2.ebuild</i>
# <i>emerge /usr/portage/net-mail/autorespond/autorespond-2.0.4.ebuild</i>
# <i>emerge /usr/portage/net-mail/qmailadmin/qmailadmin-1.2.0_rc2-r1.ebuild</i>
</pre>

<p>
你可以登录<uri>http://www.youdomain.com/cgi-bin/qmailadmin</uri> 地址进入 qmailadmin 管理界面。如果页面上的图片没有正确显示，你必须自己将其复制到正确位置，你可以查看 /var/log/apache2/error_log 以获取其位置。注意这个版本的 qmailadmin 没有使用 valias 来维护 forward/alias ，你可以从源代码安装 1.2.1 版本来实现。
</p>
</body>
</chapter>

<chapter>
<title>安装 igenus </title>
<body>
<note>我的域名是 microweb.3322.org ,以下出现 microweb.3322.org 字样你需要根据你的情况更改。</note>
<p>
到<uri>www.igenus.org</uri>下载最新的 igenus 压缩包，我下载的是 igenus_2.0_20040703_release.tgz。
</p>
<p>将下载的压缩包解压至 /va/www/localhost/htdocs，并设置所有者为 vpopmail：
</p>
<pre>
# <i>chown -R vpopmail:vpopmail /var/www/localhost/htdocs/igenus</i>
</pre>

</body>
</chapter>

<chapter>
<title>配置 igenus (第一步）</title>
<body>
<p>
建立 igenus 运行所需要的临时目录。
</p>
<pre>
# <i>mkdir /tmp/igenus</i>
# <i>cd /tmp</i>
# <i>chmod -R 0755 igenus</i>
# <i>chown -R vpopmail:vpopmail igenus</i>
# <i>cd /var/www/localhost/htdocs/igenus</i>
</pre>
<p>
修改/var/www/localhost/htdocs/igenus/config/config_inc.php，如下：
</p>
<pre caption="/var/www/localhost/htdocs/igenus/config/config_inc.php">
$CFG_BASEPATH = "/var/wwww/localhost/htdocs/igenus";
$CFG_MYSQL_HOST = 'localhost';
$CFG_MYSQL_USER = 'vpopmail';
$CFG_MYSQL_PASS = 'yourpasswd'; <codenote>此处密码为vpopmail数据库密码</codenote>
$CFG_MYSQL_DB = 'vpopmail';
$CFG_TEMP = "/tmp/igenus";
</pre>
<p>
为使用 igenus 的其他功能修改 vpopmail 数据库。同时，如果之前你已经用 vadddomain 建立了登录域，那么需要删除该域。
</p>
<pre>
# <i>/var/vpopmail/bin/vdeldomain yourdomain</i>
# <i>mysql -u root -p</i>
> use vpopmail;
> drop table vpopmail;
> quit
</pre>
<p>
然后导入 igenus 包中自带的 sql 文件，导入igenus 需要的几个表：
</p>
<pre>
# <i>mysql -u root -p vpopmail &lt; /var/www/localhost/htdocs/igenus/docs/iGENUS.sql</i>
</pre>
<note>导入工作也可以使用 phpmyadmin 等完成。</note>
<p>
成功后查看 vpopmail 数据库应该包含以下表：address,admin,dir_control,lastauth,limits,logs,message, personal ,stow,valias,vpopmail。</p>

</body>
</chapter>

<chapter>
<title>修改php.ini</title>
<body>
<p>修改 /etc/php/apache2-php4/php.ini 以下内容：</p>
<pre caption="/etc/php/apache2-php4/php.ini">
max_execution_time=60
memory_limit=20M
post_max_size=10M
file_uploads=on
upload_max_filesize=10M
register_globals=On
session.bug_compat_42=0
session.bug_compat_warn=0
sendmail_path = /var/qmail/bin/qmail-inject
</pre>

</body>
</chapter>

<chapter>
<title>修改apache2.conf</title>
<body>
<p>修改 /etc/apache2/conf/commonapache2.conf：</p>
<pre caption="/etc/apache2/conf/commonapache2.conf">
User vpopmail
Group vpopmail
</pre>
<warn>这样做有一定的安全风险，请自行决定。</warn>
<p>重启 apache2。如果重启　apache2 后发现你的其他　web 程序出现问题，你也许需要更改相应的文件为 vpopmail:vpopmail所有。</p>

</body>
</chapter>

<chapter>
<title>建立虚拟登录域</title>
<body>
<pre>
# <i>/var/vpopmail/bin/vadddomain microweb.3322.org</i>
Please enter password for postmaster: (输入 postmaster 密码)
enter password again:(再次输入密码)
</pre>
<p>
检查 /var/vpopmail/domains，下面应该可以看到建立的域名。如果要删除域，务必要使用 vdeldomain 命令，不要直接删除相应的目录。
</p>
</body>
</chapter>

<chapter>
<title>登陆 qmailadmin 建立用户</title>
<body>
<p>
打开浏览器，键入地址：http://microweb.3322.org/cgi-bin/qmailadmin/ 。以 postmaster 登陆，域为 microweb.3322.org，密码为上面设置的密码。然后可以根据页面提示新增用户。</p>
<note>你也可以使用 /var/vpopmail/bin/vadduser 命令添加用户。</note>

</body>
</chapter>

<chapter>
<title>配置 igenus (第二步)</title>
<body>
<p>
由于 vpopmail 采用的是 .maildir 格式的邮箱，而 igenus 用的是 Maildir 格式的邮箱，因此现在登陆 igenus 会出现很多错误。所以我们需要做一点变通：
</p>
<pre>
# <i>cd /var/vpopmail/domains/${yourdomain}/${youruser} </i>
# <i>ln -s .maildir Maildir</i>
# <i>chown vpopmail:vpopmail Maildir</i>
</pre>
<p>
这样 igenus 就可以读取用户邮箱了。</p>
<p>
现在就可以打开http://yourdomain/igenus 用先前建立的用户登陆你的 igenus 了。
</p>
</body>
</chapter>

<chapter>
<title>资源</title>
<section>
<title>更多信息请参考：</title>
<body>
<p>
<uri>http://forums.gentoo.org/viewtopic.php?t=171499</uri>
</p>
<p>
<uri>http://www.gentoo.org/doc/en/qmail-howto.xml</uri>
</p>
<p>
<uri>http://www.olausson.de/article3.html</uri>
</p>
</body>
</section>

<section>
<title>查看本文最新更新：</title>
<body>
<p>
<uri>http://microweb.3322.org/</uri>
</p>
<p>
<uri>http://mazda.3322.org/~max/</uri>
</p>
</body>
</section>
</chapter>

</guide>
