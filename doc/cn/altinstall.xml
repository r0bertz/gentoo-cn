<?xml version='1.0' encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" href="/xsl/guide.xsl" ?>
<!-- $Header: /var/www/www.gentoo.org/raw_cvs/gentoo/xml/htdocs/doc/en/altinstall.xml,v 1.33 2004/07/12 12:56:58 neysx Exp $ -->
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/doc/en/altinstall.xml">

<title>Gentoo另类安装指南</title>

<author title="Contributor">
  <mail link="gerrynjr@gentoo.org">Gerald Normandin Jr.</mail>
</author>
<author title="Contributor">
  <mail link="lordviram@rebelpacket.net">Travis Tilley</mail>
</author>
<author title="Contributor">
  <mail link="volontir@yahoo.com">Oleg Raisky</mail>
</author>
<author title="Contributor">
  <mail link="luminousit@hotmail.com">Alex Garbutt</mail>
</author>
<author title="Contributor">
  <mail link="alex@openvs.com">Alexandre Georges</mail>
</author>
<author title="Contributor">
  <mail link="vargen@b0d.org">Magnus Backanda</mail>
</author>
<author title="Contributor">
  <mail link="davoid@gentoo.org">Faust A. Tanasescu</mail>
</author>
<author title="Contributor">
  <mail link="aliz@gentoo.org">Daniel Ahlberg</mail>
</author>
<author title="Editor">
  <mail link="swift@gentoo.org">Sven Vermeulen</mail>
</author>
<author title="Reviewer">
  Ken Nowack <!-- antifa@gentoo.org seems out -->
</author>
<author title="Editor">
  <mail link="blubber@gentoo.org">Tiemo Kieft</mail>
</author>
<author title="Translator">
  <mail link="jinduck@163.com">Jinduck</mail>
</author>

<abstract>
这份安装指南是一份另类Gentoo安装方案的集合， 主要是针对一些比如缺少光碟机
或者电脑无法从CD引导等特殊需求而打造的。
</abstract>

<license/>

<version>0.43</version>
<date>2004年7月12日</date>

<chapter>
<title>关于此文档</title>
<section>
<body>

<p>
如果通过LIVE－CD引导安装的办法无法成功或者你不喜欢，这个文档可以给你帮助。此文档是为了那些需要通过非一般另类安装的用户提供了后备参考方案。也希望你能提供你自己的奇特安装方案的地方， 或者你找到个更加具有“娱乐性”的安装GENTOO的方案， 别质疑， 欢迎你写信给我 <mail link="antifa@gentoo.org">欢迎你写信给我</mail>
</p>

</body>
</section>
</chapter>

<chapter>
<title>用Smart BootManager 来引导Live-CD</title>
<section>
<body>

<p>
下载Smart BootManager <uri
link="http://btmgr.sourceforge.net/index.php3?body=download.html">http://btmgr.sourceforge.net/index.php3?body=download.html</uri>.
LINUX源码包， 二进位文件和WINDOWS的EXE版本都可以在以上网站寻找到， 并且包含各种语言包。但是， 就目前来讲， 比较好的方法是下载二进位文件， 因为源码不会被新版的NASM所编译。.
</p>

<p>
编译源码包和直接执行二进位文件， 你可以选择任意两个格式。当你要建立引导磁盘的时候还有不同的选择， 请看以下源码：
</p>

<pre caption="Smart BootManager 选项">
<i>sbminst [-t theme] [-d drv] [-b backup_file] [-u backup_file]

   -t theme     选择你所使用的主题（注：语系主题）， 其中有:
                   us = 美国主题           de = 德国主题
                   hu = 匈牙利主题         zh = 中国主题
                   ru = 俄罗斯主题         cz = 捷克主题
                   es = 西班牙主题         fr = 法国主题
                   pt = 葡萄牙主题
                 
  -d drv       设定你要安装smart bootmanager的分区
                Linux下:
                  /dev/fd0 is the first floppy driver,
                  /dev/hda is the first IDE harddisk driver.
                   /dev/sda is the first SCSI harddisk driver.
                DOS下:
                   0   is the first floppy drive
                   128 is the first hard drive;

   -c             停止光盘机引导;

   -b backup_file 备份将来卸装时可能要用的文件


   -u backup_file 卸装smart bootmanager，需要单独执行;

   -y             不要求任何问题或者警告</i>
</pre>

<pre caption="使用 sbminst 建立引导磁盘">
# <i>sbminst -t us  -d /dev/fd0</i>
</pre>

<note>
如果你的软盘不是fd0, 请更换你自己的软盘名称。
</note>

<p>
现在你可以将磁盘放入来引导LIVECD启动了， 同时记得把LIVECD放入你的光盘机，启动电脑。
</p>

<p>
当启动完成后， 你会件到SMART BOOTMANAGER的对话窗， 选择你的CDROM后摁ENTER来启动LIVECD。当引导正常后， 你可以按照一般安装指南来进行安装了。
</p>

<p>
详细关于SMART BOOTMANAGER的讯息可以参考网站
<uri>http://btmgr.sourceforge.net/</uri>
</p>

</body>
</section>
</chapter>

<chapter>
<title>KNOPPIX的Live-CD来安装GENTOO</title>
<section>
<body>

<p>
从<uri link="http://www.knoppix.org/">Knoppix</uri> 的Live-CD引导是一种在你编译的时候能够提供一个完全功能化的LINUX系统环境的办法。
Tux Racer可以帮你打发等待bootstrap的时间。
</p>

<p>
虽然你需要自己加装一些引导选项， 但一般来说从Knoppix CD引导， 它可以出色的侦测到你现有的硬体。
</p>

<p>
KNOPPIX的LIVE-CD会默认进入KDE3。0的桌面。而进去后我第一件事情就是开启KONSOLE并且输入<c>sudo passwd root</c>。这样系统可以让你设置KNOPPIX的ROOT口令了。
</p>

<p>
跟着我用su切换直ROOT， 并输入<c>usermod  -d  /root  -m</c>。 这个可以让你在/root下建立用户的家目录。如果你不这么做的话， 你会在emerging /home/root的时候看到错误讯息“/home/root: not found”, 或者其他因为这样而引起的错误。
</p>

<p>
接着我输入<c>exit</c>， 并且用<c>su</c>切换回ROOT。这样可以恢复因为usemode指令所带来的改变值。 接着用<c>mkdir</c>建立<path>/mnt/gentoo</path> 的挂载点:
</p>

<pre caption="建立/mnt/gentoo mountpoint挂载点">
# <i>mkdir /mnt/gentoo</i>
</pre>

<p>
到现在， 你可以打开<uri
link="/doc/en/handbook/handbook-x86.xml?part=1&amp;chap=4">一般安装文件的第四章</uri>， 但是要注意， 当你要挂载proc系统的时候， 请按以下指令更换：
</p>

<pre caption="Bind-mounting the proc pseudo filesystem">
# <i>mount -o bind /proc /mnt/gentoo/proc</i>
</pre>

</body>
</section>
</chapter>

<chapter>
<title>不用网络从stage1开始安装</title>
<section>
<body>

<p>
从LiveCD iso刻录一张引导CD .
</p>

<p>
从<uri>http://distro.ibiblio.org/pub/linux/distributions/gentoo/snapshots/</uri>
(或者从你自己喜欢的<uri
link="http://www.gentoo.org/main/en/mirrors.xml">镜像</uri>)下载portage的快照。你可以将它置放在现有的分区或者直接将它刻录在CD里。
</p>

<p>
接着按照GENTOO的一般安装指南的步骤进行到第六章里的<c>chroot /mnt/gentoo</c>。如果你是用两张CD， 一张LIVE－CD， 一张快照的话， 记得使用<c>cdcache</c>功能， 这样你可以在安装的时候卸载LIVE－CD， 再挂载快照CD了。
</p>

<p>
用(alt-F2)开启另一个终端，我们将继续按照一般安装指南直到运行bootstrap.sh的脚本的时候。
</p>

<warn>
当你执行<c>passwd</c>的命令的时候，旧的LIVE－CD会需要你在手动登入前改变口令。
</warn>

<p>
用(alt-F1不需要chroot)可以转回到第一个终端， 接着将第二张光碟挂载到<path>/mnt/gento/mnt/cdrom2</path> 复制portage的tarball到<path>/mnt/gentoo/usr/portage</path>并解压缩。
</p>

<pre caption="挂载快照CD">
# <i>umount /mnt/cdrom</i>
# <i>mkdir /mnt/gentoo/mnt/cdrom2</i>
# <i>mount /dev/cdroms/cdrom0 /mnt/gentoo/mnt/cdrom2</i>
# <i>cp /mnt/gentoo/mnt/cdrom2/portage-$date.tar.bz2 /mnt/gentoo/usr/portage</i>
# <i>cd /mnt/gentoo/usr/portage</i>
# <i>tar xvjpf portage-$date.tar.bz2</i>
</pre>

<p>
接着用Alt-F2在回到第二个终端。 如果现在你执行bootstrap.sh会失败， 因为现在系统还不能下载任何文件。我们将从其他地方“得到”这些文件并将他们置放在/usr/portage/distfiles（这些都会在第二个终端F2上执行）
</p>

<p>
我们需要关于stage1的软件包如下：
glibc, baselayout, texinfo, gettext, zlib, binutils, gcc, ncurses 和它们的依赖包。
</p>

<note>
你的portage版本要和你的portage树吻合。
</note>

<pre caption="获得下载清单">
<comment>(不要忘了&gt;之前有个2)</comment>
# <i>emerge -fp glibc baselayout texinfo gettext zlib binutils gcc ncurses 2&gt; stage1.list</i>
# <i>mount -t vfat /dev/fd0 /mnt/floppy</i>
# <i>cp /mnt/gentoo/stage1.list /mnt/floppy</i>
# <i>umount /mnt/floppy</i>
</pre>

<p>
放入一张干净的磁盘到电脑。如果你看一下<path>stage1.list</path>文件， 你会发现它提供不少URL的网址用做下载。但很可惜， 不少提供的网址里不是全部都是你想要的软件包。所以去掉所有的网址， 只留下一个：
</p>

<pre caption="删除URLs">
<comment>(这个脚本的输出格式是依赖emerge的，所以请小心使用！)</comment>
# <i>cut -f 1 -d ' ' stage1.list > stage1.download</i>
</pre>

<p>
现在我们可以用<c>wget</c>来获得所有的清单上的文件
</p>

<pre caption="利用wget获得软件包">
# <i>wget -N -i stage1.download</i>
</pre>

<p>
当你获得所有的文件后， 将他们复制到<path>/mnt/gentoo/usr/portage/distfiles/</path>, 这样你就可以执行<c>bootstrap.sh</c>, 当你执行到stage2 和stage3的时候， 重复刚刚wget来获得文件。
</p>

</body>
</section>
</chapter>

<chapter>
<title>无光盘无软盘通过PXE引导安装方案</title>
<section>
<title>软硬件需求</title>
<body>

<p>
你需要一张网卡在你的客户端，而这个客户端将用PXE协定来引导， 像很多3com的网卡一样。而且你的BIOS必须支持PXE引导。
</p>

</body>
</section>
<section>
<title>服务端架设</title>
<body>

<p>
建立一个目录：第一件事情就是建立一个目录用作无盘系统的存储夹。我们可以设置为<path>/diskless</path>, 而里面再给每个客户端建立一个子目录。我们后面的指南就集中在用户目录的ata子目录了。
</p>

<pre caption="目录创建">
# <i>mkdir /diskless</i>
# <i>mkdir /diskless/eta</i>
# <i>mkdir /diskless/eta/boot</i>
</pre>

<p>
DHCP和TFTP的架设：用户端将通过DHCP来获得引导讯息并通过TFTP来下载所有相应的文件。现在你只需要emerge DHCP并且配置他作为基本的安装需求。接着， 在<path>/etc/dhcp/dhcpd.conf</path>里加上以下的源码：
</p>

<note>
这里提供的是一个静态IP位置和PXE引导镜像(pxegrub)的路径给客户端. 你必须换成客户端的乙太卡的MAC位置和你置放客户端文件的目录。
</note>

<pre caption="dhcp.conf">
option option-150 code 150 = text ;
host eta {
hardware ethernet 00:00:00:00:00:00;
fixed-address <i>ip.add.re.ss</i>;
option option-150 "/eta/boot/grub.lst";
filename "/eta/boot/pxegrub";
}
</pre>

<p>
用<c>emerge app-admin/tftp-hpa</c>来获得TFTP。 在<path>/etc/conf.d/in.tftpd</path>加入以下的源码：
</p>

<pre caption="in.tftpd">
INTFTPD_PATH="/diskless"
INTFTPD_USER="nobody"
INTFTPD_OPTS="-u ${INTFTPD_USER} -l -vvvvvv -p -c -s ${INTFTPD_PATH}"
</pre>

<p>
建立GRUB：我用GRUB来执行PXE的引导。你必须自己编译使得启动PXE的映像编译功能。这个非查功能容易。第一， 获得最新的GRUB源码 （<c>emerge -f grub</c>会下载grub的tar-ball到你的<path>/usr/portage/distfiles</path>). 再来复制tarball到你的tarball到<path>/diskless</path>并且编译成pxe的二进位文件。当二进位文件建立完毕，将他复制到diskless用户的boot目录下。接着编辑grub.lst文件。
</p>

<pre caption="grub setup">
# <i>tar zxvf grub-0.92.tar.gz</i>
# <i>cd grub-0.92</i>
# <i>./configure --help</i>
<codenote>在选择项里你会看到所有支持的网卡驱动.</codenote>
<codenote>选择一个和你网卡想吻合的。这里我们用$nic.</codenote>
# <i>./configure --enable-diskless --enable-$nic</i>
# <i>make</i>
# <i>cd stage2</i>
# <i>cp pxegrub /diskless/eta/boot/pxegrub</i>
# <i>nano -w /diskless/eta/boot/grub.lst</i>
</pre>

<pre caption="grub.lst">
default 0
timeout 30

title=Diskless Gentoo
root (nd)
kernel /eta/bzImage ip=dhcp root=/dev/nfs nfsroot=<i>ip.add.re.ss</i>:/diskless/eta

<codenote>nfsroot的选项里， Ip位置是服务端的IP </codenote>
<codenote>而目录是diskless客户文件的所在的目录(服务端上）</codenote>
</pre>

<p>
架设NFS： NFS的配置很简单。唯一你要做的就是在<path>/etc/exports</path>的配置文件里加上一行：
</p>

<pre caption="/etc/exports">
# <i>nano -w /etc/exports</i>
# /etc/exports: NFS file systems being exported.  See exports(5).
/diskless/eta eta(rw,sync,no_root_squash)
</pre>

<p>
更行你的hosts文件：编辑<path>/etc/hosts</path> 文件
</p>

<pre caption="/etc/hosts">
127.0.0.1 localhost

192.168.1.10 eta.example.com eta
192.168.1.20 sigma.example.com sigma
</pre>

</body>
</section>
<section>
<title>在服务端建立系统</title>
<body>

<p>
从新启动服务端， 并用GENTOO的LIVECD引导。按照一般安装指南步骤安装除了以下的地方和安装指南不同外： 当你挂载文件系统的时候， 按照以下的源码执行（hdaX是/diskless目录下的分区）。你不用在挂载其他的分区， 所有的文件都将在<path>/diskless/eta</path>目录里。
</p>

<pre caption="挂载文件系统">
#<i> mount /dev/hda3 /mnt/gentoo</i>
</pre>

<p>
Stage的tarball和chroot: 这个例子用stage3的tarball。挂载<path>/proc</path>到你的diskless目录下并且chroot， 然后继续安装。接着按照一般安装指南安装一直到内核配置（编译前）
</p>

<warn>
当你解压缩tarball的时候要很小心，不能中断解压缩程序。
</warn>

<pre caption="解压stage tarball">
# <i>cd /mnt/gentoo/diskless/eta/</i>
# <i>tar -xvjpf  /mnt/cdrom/gentoo/stage3-*.tar.bz2</i>
# <i>mount -t proc /proc /mnt/gentoo/diskless/eta/proc</i>
# <i>cp /etc/resolv.conf /mnt/gentoo/diskless/eta/etc/resolv.conf</i>
# <i>chroot /mnt/gentoo/diskless/eta/ /bin/bash</i>
# <i>env-update</i>
# <i>source /etc/profile</i>
</pre>

<p>
内核配置： 当你开始make menuconfig的时候， 不要忘了将以下几个选项加入：
</p>

<pre caption="menuconfig 选项">
- Your network card device support

- 在 "Networking options" :

[*] TCP/IP networking
[*] IP: kernel level autoconfiguration
[*] IP: DHCP support
[*] IP: BOOTP support


- 在 "File systems --> Network File Systems" :

&lt;*&gt; NFS file system support
[*] Provide NFSv3 client support
[*] Root file system on NFS
</pre>

<p>
接下来配置diskless目录下的<path>/etc/fstab</path>:
</p>

<pre caption="/etc/fstab">
# <i>nano -w /etc/fstab</i>
/dev/cdroms/cdrom0 /mnt/cdrom iso9660 noauto,ro 0 0
proc /proc proc defaults 0 0
tmpfs /dev/shm tmpfs defaults 0 0
</pre>

<p>
不要安装任何的引导装置因为你已经有一个了：pxegrub。简单的完成安装后重新启动服务端。启动你需要的服务可以让用户端引导的：DHCP，TFTPD，和NFS。
</p>

<pre caption="Starting services">
# <i>/etc/init.d/dhcp start</i>
# <i>/etc/init.d/tftpd start</i>
# <i>/etc/init.d/nfs start</i>
</pre>

</body>
</section>
<section>
<title>启动引导新的客户</title>
<body>

<p>
为了让客户端启动引导正常，你需要配置BIOS和网卡， 这样可以让PXE先引导。网卡必须配置DHCP并且通过TFTP下载GRUBPXE 映像。接着， 你应该可以看到一个黑白的GRUB启动菜单了， 而这里可以让你选择内核引导， 接着你摁ENTER。如果一切顺利的话， 内核将会通过NFS挂载根目录并且提供登入菜单。
</p>

</body>
</section>
</chapter>

<chapter>
<title>在其他LINUX发行版内安装GENTOO方案</title>
<section>
<title>安装需求</title>
<body>

<p>
要在你现有的LINUX发行版里安装GENTOO， 你需要安装chroot指令和一份GENTOO安装tarball或者ISO映像文件。如果你想获得更多的文件安装， 你需要有网路支持。（tarball的后缀是tbz或者tar.gz). 我是用REDHAT 7。3做为“母体”操作系统， 当然这些不重要， 我们现在开始安装！
</p>

</body>
</section>
<section>
<title>安装概要</title>
<body>

<p>

We will first allocate a partition to Gentoo by resizing our existing Linux
partition, mount the partition, untar the tarball that is mounted, chroot
inside the psuedo-system and start building. Once the bootstrap process is
done, we will do some final configuration on the system so as to make sure it
boots, then we are ready to reboot and use Gentoo.
</p>

</body>
</section>
<section>
<title>How should we make space for Gentoo?</title>
<body>

<p>
我们需要首先在现有的LINUX分区下划分一个分区给GENTOO， 然后挂载并将tarball解压缩后放置里面。然后用chroot进入虚拟系统并且开始安装。当bootstrap的程序完成后， 我们就进行最后的撇之接着可以启动GENTOO系统。如何划分分区给GENTOO呢？根分区是被挂载在<path>/</path>下。我们可以用df来检查看看根分区还有多少空间剩余并且怎样在里面划分出空间给GENTOO。要注意的是划分现有的根分区不是一定要的。你也可以划分其他的分区。我会等会在来说明的。
</p>

<pre caption="文件系统资讯">
# <i>mount</i>
/dev/hdb2 on / type ext3 (rw)
none on /proc type proc (rw)
none on /dev/pts type devpts (rw,gid=5,mode=620)
none on /dev/shm type tmpfs (rw)
# <i>df -h </i>
Filesystem           Size Used Avail Use% Mounted on
/dev/hdb2            4.0G 1.9G  2.4G  82% /
none		      38M    0    38M   0% /dev/shm
</pre>

<p>
好像上面我们看到得一样，/dev/hdb2有2。4G剩余， 挂载在<path>/</path>下。在我的例子里， 我会分从新分配使得我原来的根分区变成400M的剩余而拨给GENTOO 2G的空间。看上去分配得好像还不错， 因为我有很多东西要安装。
</p>

</body>
</section>
<section>
<title>重新分配分区</title>
<body>

<p>
Parted 是一种基于GNU的老式软件项目， 而你即将要用到它。其中一个工具叫PARTED PARTITION（可从<uri>http://www.gnu.org/software/parted/</uri>取得）对我们即将要做的步骤非常有用。
</p>

<note>
有很多支持重新分配分区大小的软件， 如PARTITION－MAGIC， 这里我没有详细了解过， 诉以读者可以按照自己的喜好来选择分区软件。
</note>

<p>
用刚刚上面的方法查询一下文件系统类型并且确认你现有的分区是可挂载的。 如果不行， 你必须要重新删除你现有的分区， 等非配完后， 以后再安装回来。现在有个小问题， 如果我们要重新分配现有的根分区<path>/</path>， 就必须要建立一个能够引导并且足够小的开机磁盘。当然， 如果你要重新划分的分区不是根分区并且可以卸载的话， 你可以不必照以下步骤作。下面的是我如何在我的系统下完成的：
</p>

<impo>
确认你要执行的命令是被parted支持的！
</impo>

<p>
从<uri>http://freshmeat.net/tomsrtbt </uri>下载 tomsrtbt boot/root， 然后建立一张可引导磁盘：
</p>


<pre caption="建立引导磁盘">
# <i>mkfs.minix /dev/fd0</i>
480 inodes
1440 blocks
Firstdatazone=19 (19)
Zonesize=1024
Maxsize=268966912
</pre>

<p>
我们现在要开是分割分区，首先要作的是执行以下的命令建立一个工具磁盘：
</p>

<pre caption="建立工具磁盘">
# <i> mkdir /floppy; mount -t minix /dev/fd0 /floppy &amp;&amp;
export CFLAGS="-O3 -pipe -fomit-frame-pointer -static" &amp;&amp; ./configure
&amp;&amp; make &amp;&amp; cp parted/parted /floppy &amp;&amp; umount /floppy </i>
</pre>

<p>
现在你可以重新开机并且划分分区了。重新在一个较大的硬盘上划分分区大概要用上30分钟， 所以要给点耐心。重新启动后， 用tomsrtbt的引导磁盘引导， 当你登入以后， 换成刚刚完成的工具磁盘， 输入：mount /dev/hd0 /floppy来挂载。接着执行parted你就可以重新划分分区了。当划分结束， 我们就可以开始安装GENTOO。重新启动系统进入老的LINUX里，准备安装GENTOO。
</p>

<pre caption="Commands to run once logged into tomsrtbt system">
# <i>mount /dev/fd0 /floppy </i>
# <i>cd /floppy; ./parted [drive you wish to operate on]</i>
(parted) <i> print </i>
Disk geometry for /dev/hdb: 0.000-9787.148 megabytes
Disk label type: msdos
Minor    Start       End     Type      Filesystem  Flags
1          0.031   2953.125  primary   ntfs
3       2953.125   3133.265  primary   linux-swap
2       3133.266   5633.085  primary   ext3
4       5633.086   9787.148  extended
5       5633.117   6633.210  logical
6       6633.242   9787.148  logical   ext3
(parted) <i> help resize </i>
  resize MINOR START END        resize filesystem on partition MINOR

        MINOR is the partition number used by Linux.  On msdos disk labels, the
        primary partitions number from 1-4, and logical partitions are 5
        onwards.
        START and END are in megabytes
(parted) <i> resize 2 3133.266 4000.000 </i>
</pre>


<p>
接着就可以按照<uri link="/doc/en/handbook/handbook-x86.xml?part=1&amp;chap=4">一般安装指南</uri>进行安装了。到chrooting的时候， 请用以下指令清除你现有的环境：
</p>

<pre caption="Flushing the environment during chroot">
# <i>env -i /usr/sbin/chroot /mnt/gentoo /bin/bash</i>
</pre>

<p>
祝你成功
</p>

</body>
</section>
</chapter>

</guide>
